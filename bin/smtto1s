#! /usr/bin/tclsh
#
# smtto1s - convert an OSIsoft PI SMT file to 1s data single column data
#
# Note: the input is generated by the OSIsoft PI SMT which
#   seems to be particularly unpleasant, e.g.
#
#   1. The first few samples often wrong (from the wrong time)
#   2. Time travel can occur fairly often where the output
#      is not increasing in time (ok the NTP server had a hiccup)
# 

proc emit {t v} {
  if {![string is double $v]} {
    set v 0.0
  }
  if {$t == 0} {
    set ::ot $t
    set ::ov $v
    puts "$v"
  } else {
    while {$::ot < $t} {
      incr ::ot
      puts "$::ov"
    }    
    puts "$v"
    set ::ot $t
    set ::ov $v
  }
}
    
set nr 0
gets stdin l
set t0 -1
while {[gets stdin l] > 0} {
  incr nr
  if {$nr < 5} {
    continue ;# skip the bad samples from SMT (PI tools :-...)
  }
  set s [split $l ,]
  set v [lindex $s 2]
  set t [lindex $s 3]
  set t [string range $t 0 end-4] ;# remove ms
      set t [clock scan $t]
  if {$t0 == -1} {
    set t0 $t
  }	 
  set tb [expr $t-$t0]
  if {$tb < 0} {
    puts "Time travel at $nr"
    exit 0
  }    
  emit $tb $v
}
